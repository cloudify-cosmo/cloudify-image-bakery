#!/bin/bash
set -e -x

INSTALL_RPM="cloudify-manager-install.rpm"
CONFIG_FILE_PATH="/etc/cloudify/config.yaml"


function os_configure
{
  # disable selinux
  sudo setenforce Permissive
  sudo sed -ri 's/SELINUX=.+/SELINUX=Permissive/' /etc/selinux/config

  # Set hostname
  sudo hostnamectl set-hostname cloudify

  # Disable requiretty for future fabric calls
  sudo sed -i -e 's/^Defaults.*requiretty/# Defaults requiretty/g' /etc/sudoers

  # Make sure all packages are up to date
  yum_log=$(mktemp)
  sudo yum update -y 2>&1 | tee "$yum_log"

  # Check for "Non-fatal" errors because yum won't
  if $(grep -i 'non-fatal' "$yum_log")
  then
      rm "$yum_log"
      echo "yum failed to install all packages cleanly"
      exit 1
  fi
}

function install_rpm
{
  echo "Downloading Cloudify's install RPM from: ${INSTALL_RPM_URL}"
  curl ${INSTALL_RPM_URL} -o ${INSTALL_RPM} -s

  echo "Installing RPM..."
  sudo yum install -y ${INSTALL_RPM}

  rm ${INSTALL_RPM}
}

os_configure
install_rpm
